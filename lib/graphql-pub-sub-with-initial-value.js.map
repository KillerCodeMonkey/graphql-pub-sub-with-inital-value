{"version":3,"file":"graphql-pub-sub-with-initial-value.js","sources":["../src/index.ts"],"sourcesContent":["import { PubSub } from 'graphql-subscriptions'\n\nexport interface AsyncIterableIteratorWithInitialState<T> extends AsyncIterableIterator<T> {\n  initialValuePushed: boolean\n}\n\nexport const withCancel = <T, P>(\n  asyncIterator: AsyncIterator<T | undefined>,\n  onCancel: (args?: P) => void,\n  args?: P\n): AsyncIterator<T | undefined> => {\n  if (!asyncIterator.return) {\n    asyncIterator.return = () => Promise.resolve({\n      done: true,\n      value: undefined\n    })\n  }\n\n  const savedReturn = asyncIterator.return.bind(asyncIterator)\n  asyncIterator.return = () => {\n    onCancel(args)\n    return savedReturn()\n  }\n\n  return asyncIterator\n}\n\nexport class PubSubWithIntialValue extends PubSub {\n  private withInitialValue<T>(iterator: AsyncIterator<T>, getInitialValue: () => Promise<T>): AsyncIterableIteratorWithInitialState<T> {\n    return {\n      [Symbol.asyncIterator](): AsyncIterableIterator<T> { return this },\n      initialValuePushed: false,\n      next(value?: any): Promise<IteratorResult<T>> {\n        if (this.initialValuePushed) {\n          return iterator.next(value).then(({ value, done }: IteratorResult<T>): IteratorResult<T> => ({\n            done,\n            value\n          }))\n        } else {\n          return getInitialValue().then((value: T): IteratorResult<T> => {\n            this.initialValuePushed = true\n            return { done: false, value }\n          })\n        }\n      },\n      return(value?: any): Promise<IteratorResult<T>> {\n        return iterator.return!(value)\n      },\n      throw(value?: any): Promise<IteratorResult<T>> {\n        return iterator.throw!(value)\n      }\n    }\n  }\n\n  public asyncIteratorWithInitialValue<T>(topic: string | string[], initialValueFn: () => Promise<T>): AsyncIterableIteratorWithInitialState<T> {\n    return this.withInitialValue(this.asyncIterator<T>(topic), (): Promise<T> => initialValueFn())\n  }\n\n  public withCancel<T, P>(asyncIterator: AsyncIterator<T | undefined>, onCancel: (args?: P) => void, args?: P): AsyncIterator<T, any, undefined> {\n    return withCancel<T, P>(asyncIterator, onCancel, args)\n  }\n}\n"],"names":["withCancel","asyncIterator","onCancel","args","Promise","resolve","done","value","undefined","savedReturn","bind","_PubSub","PubSubWithIntialValue","apply","arguments","this","_proto","prototype","withInitialValue","iterator","getInitialValue","_ref2","Symbol","initialValuePushed","next","_this","then","_ref","asyncIteratorWithInitialValue","topic","initialValueFn","PubSub"],"mappings":"gKAMa,IAAAA,EAAa,SACxBC,EACAC,EACAC,GAEKF,EAAa,SAChBA,EAAoB,OAAG,WAAM,OAAAG,QAAQC,QAAQ,CAC3CC,MAAM,EACNC,WAAOC,GACP,GAGJ,IAAMC,EAAcR,SAAqBS,KAAKT,GAM9C,OALAA,EAAoB,OAAG,WAErB,OADAC,EAASC,GACFM,GACT,EAEOR,CACT,6CAEmCU,SAAAA,WAAA,SAAAC,IAAAD,OAAAA,EAAAE,WAAAC,YAAAC,IAAA,GAAAJ,KAAAC,yEAAA,IAAAI,EAAAJ,EAAAK,UAiChCL,OAjCgCI,EACzBE,iBAAA,SAAoBC,EAA4BC,GAAiCC,IAAAA,EACvF,OAAAA,EAAAA,CAAAA,GACGC,OAAOrB,eAAa,WAAgC,OAAOc,IAAK,EAACM,EAClEE,oBAAoB,EAAKF,EACzBG,KAAI,SAACjB,GAAWkB,IAAAA,OACd,OAAIV,KAAKQ,mBACAJ,EAASK,KAAKjB,GAAOmB,KAAK,SAAAC,GAAc,MAA8C,CAC3FrB,KAD6CqB,EAAJrB,KAEzCC,MAFuCoB,EAALpB,MAGnC,GAEMa,IAAkBM,KAAK,SAACnB,GAE7B,OADAkB,EAAKF,oBAAqB,EACnB,CAAEjB,MAAM,EAAOC,MAAAA,EACxB,EAEJ,EAACc,kBACMd,GACL,OAAOY,EAAQ,OAASZ,EAC1B,EAACc,EAAA,MAAA,SACKd,GACJ,OAAOY,EAAQ,MAAQZ,EACzB,EAACc,CAEL,EAACL,EAEMY,8BAAA,SAAiCC,EAA0BC,GAChE,YAAYZ,iBAAiBH,KAAKd,cAAiB4B,GAAQ,WAAkB,OAAAC,GAAgB,EAC/F,EAACd,EAEMhB,WAAA,SAAiBC,EAA6CC,EAA8BC,GACjG,OAAOH,EAAiBC,EAAeC,EAAUC,EACnD,EAACS,CAAA,CAjCgCD,CAAQoB,EAAMA"}